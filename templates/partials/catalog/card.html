{% load humanize %}
<div class="card bg-white rounded-lg shadow-md tracking-wide overflow-hidden border border-gray-200 transition-all duration-300 hover:shadow-xl w-60">
  <!-- Изображение и теги -->
  <div class="relative w-full h-[215px] overflow-hidden group">
    <!-- Контейнер для карусели -->
    <div class="relative w-full h-full cursor-pointer" data-carousel 
         data-images='[
           "{{ album.image.url }}"
           {% for image in album.image_gallery.all|slice:":7" %}
             {% if forloop.first %},{% endif %}
             "{{ image.image.url }}"
           {% endfor %}
         ]'
         data-total-images="{% with gallery_length=album.image_gallery.all|length %}{{ gallery_length|add:1 }}{% endwith %}">
      <!-- Основное изображение (первое в карусели) -->
      <img src="{{ album.image.url }}" alt="{{ album.name }}" class="absolute w-full h-full object-cover transition-all duration-300 z-10" data-carousel-image>
      <!-- Остальные изображения -->
      {% for image in album.image_gallery.all|slice:":7" %}
          <img src="{{ image.image.url }}" alt="{{ album.name }} Preview" class="absolute w-full h-full object-cover transition-all duration-300 z-0" data-carousel-image loading="lazy" decoding="async">
      {% endfor %}
      <!-- Формат на черном фоне -->
      <span class="absolute bottom-2 left-2 bg-black/55 text-white text-xs font-medium px-2.5 py-1 rounded-md z-20">
        {{ album.get_format }}
      </span>
    </div>
  </div>

  <!-- Контент -->
  <div class="p-3.5 relative">
    <!-- Точки переключения -->
    <div class="relative flex justify-center mb-2.5 -mt-0.5 space-x-2 z-10" data-carousel-dots>
      {% with gallery_length=album.image_gallery.all|length|add:1 %}
          {% for i in "x"|ljust:gallery_length %}
              <button type="button" class="w-1.5 h-1.5 rounded-full bg-black/20 transition-all duration-300 hover:bg-black/80 hover:scale-125 cursor-pointer focus:outline-none" data-dot-index="{{ forloop.counter0 }}" aria-label="Показать фото {{ forloop.counter }}"></button>
          {% endfor %}
      {% endwith %}
    </div>

    <!-- Артист и альбом -->
    <div class="flex items-start gap-[11px]">
      <div class="w-[3px] h-8 mt-1 bg-blue-500 rounded-full"></div>
      <div>
        <h5 class="text-sm font-medium text-gray-700 hover:text-blue-600 transition-colors duration-300">
          <a href="{{ album.artist.get_absolute_url }}">{{ album.artist.name }}</a>
        </h5>
        <h5 class="text-base font-bold text-gray-900 hover:text-blue-600 transition-colors duration-300 -mt-0.5">
          <a href="{{ album.get_absolute_url }}">{{ album.name }}</a>
        </h5>
      </div>
    </div>

    <!-- Состояние (condition) -->
    {% if album.condition %}
      <span class="absolute top-[30px] right-3 w-8 h-6 flex items-center justify-center font-geologica font-medium rounded-md text-[10px] bg-gray-100 text-gray-700" title="Состояние: {{ album.condition }}">
        {{ album.condition|truncatechars:2|upper }}
      </span>
    {% endif %}

    <!-- Информация -->
    <ul class="mt-1.5 space-y-1 text-xs text-gray-600">
      <li>
        {% if album.styles.exists %}
          {% for style in album.styles.all %}
            {{ style.name }}{% if not forloop.last %}, {% endif %}
          {% endfor %}
        {% endif %}
      </li>
      <li>
        {% if album.stock %}
          <span class="text-green-600 font-medium">В наличии ({{ album.stock }} шт.)</span>
        {% else %}
          <span class="text-red-600 font-medium">Нет в наличии</span>
        {% endif %}
      </li>
    </ul>

    <!-- Цена и кнопки -->
    <div class="mt-1.5 flex items-center justify-between">
      <!-- Цена из прайс-листа -->
      <span class="text-xl font-bold">{{ album.current_price|floatformat:0|default:'0'|intcomma }} ₽</span>

      <!-- Кнопки -->
      <div class="flex items-center gap-2 opacity-75">
        <!-- Кнопка "В корзину" -->
        {% if request.user.is_authenticated %}
          {% if album.stock %}
            {% if album not in cart.products_in_cart %}
              <a href="{% url 'add_to_cart' ct_model=album.ct_model slug=album.slug %}" class="p-1.5 bg-blue-500 text-white rounded-md hover:bg-blue-600 transition-all duration-300 hover:scale-105" title="Добавить в корзину">
                <svg class="w-5 h-5" xmlns="http://www.w3.org/2000/svg" fill="currentColor" viewBox="0 0 24 24">
                  <path fill-rule="evenodd" d="M10 2.25a1.75 1.75 0 00-1.582 1c-.684.006-1.216.037-1.692.223A3.25 3.25 0 005.3 4.563c-.367.493-.54 1.127-.776 1.998l-.047.17-.513 2.964c-.185.128-.346.28-.486.459-.901 1.153-.472 2.87.386 6.301.545 2.183.818 3.274 1.632 3.91C6.31 21 7.435 21 9.685 21h4.63c2.25 0 3.375 0 4.189-.635c.814-.636 1.086-1.727 1.632-3.91.858-3.432 1.287-5.147.386-6.301a2.186 2.186 0 00-.487-.46l-.513-2.962-.046-.17c-.237-.872-.41-1.506-.776-2a3.25 3.25 0 00-1.426-1.089c-.476-.186-1.009-.217-1.692-.222A1.75 1.75 0 0014 2.25zm8.418 6.896l-.362-2.088c-.283-1.04-.386-1.367-.56-1.601a1.75 1.75 0 00-.768-.587c-.22-.086-.486-.111-1.148-.118A1.75 1.75 0 0114 5.75h-4a1.75 1.75 0 01-1.58-.998c-.663.007-.928.032-1.148.118a1.75 1.75 0 00-.768.587c-.174.234-.277.56-.560 1.6l-.362 2.089C6.58 9 7.91 9 9.685 9h4.63c1.775 0 3.105 0 4.103.146M8 12.25a.75.75 0 01.75.75v4a.75.75 0 01-1.5 0v-4a.75.75 0 01.75-.75m8.75.75a.75.75 0 00-1.5 0v4a.75.75 0 001.5 0v-4M12 12.25a.75.75 0 01.75.75v4a.75.75 0 01-1.5 0v-4a.75.75 0 01.75-.75" clip-rule="evenodd"/>
                </svg>
              </a>
            {% else %}
              <a href="{% url 'remove_from_cart' ct_model=album.ct_model slug=album.slug %}" class="p-1.5 bg-gray-100 text-blue-500 rounded-md hover:bg-gray-200 transition-all duration-300 hover:scale-105" title="Удалить из корзины">
                <svg class="w-5 h-5" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                  <path stroke-linecap="round" stroke-linejoin="round" stroke-width="3.5" d="M5 13l4 4L19 7" />
                </svg>
              </a>
            {% endif %}
          {% else %}
            {% if album in request.user.customer.wishlist.all %}
              <a href="{% url 'remove_from_wishlist' album_id=album.id %}" class="p-1.5 bg-gray-100 text-yellow-400 rounded-md hover:bg-gray-200 transition-all duration-300 hover:scale-105" title="Удалить из списка ожидания">
                <svg class="w-5 h-5" xmlns="http://www.w3.org/2000/svg" fill="currentColor" viewBox="0 0 1024 1024">
                  <path d="m908.1 353.1l-253.9-36.9L540.7 86.1c-3.1-6.3-8.2-11.4-14.5-14.5c-15.8-7.8-35-1.3-42.9 14.5L369.8 316.2l-253.9 36.9c-7 1-13.4 4.3-18.3 9.3a32.05 32.05 0 0 0 .6 45.3l183.7 179.1l-43.4 252.9a31.95 31.95 0 0 0 46.4 33.7L512 754l227.1 119.4c6.2 3.3 13.4 4.4 20.3 3.2c17.4-3 29.1-19.5 26.1-36.9l-43.4-252.9l183.7-179.1c5-4.9 8.3-11.3 9.3-18.3c2.7-17.5-9.5-33.7-27-36.3"/>
                </svg>
              </a>
            {% else %}
              <a href="{% url 'add_to_wishlist' album_id=album.id %}" class="p-1.5 bg-gray-100 text-gray-400 rounded-md hover:bg-gray-200 transition-all duration-300 hover:scale-105" title="Добавить в список ожидания">
                <svg class="w-5 h-5" xmlns="http://www.w3.org/2000/svg" fill="currentColor" viewBox="0 0 1024 1024">
                  <path d="m908.1 353.1l-253.9-36.9L540.7 86.1c-3.1-6.3-8.2-11.4-14.5-14.5c-15.8-7.8-35-1.3-42.9 14.5L369.8 316.2l-253.9 36.9c-7 1-13.4 4.3-18.3 9.3a32.05 32.05 0 0 0 .6 45.3l183.7 179.1l-43.4 252.9a31.95 31.95 0 0 0 46.4 33.7L512 754l227.1 119.4c6.2 3.3 13.4 4.4 20.3 3.2c17.4-3 29.1-19.5 26.1-36.9l-43.4-252.9l183.7-179.1c5-4.9 8.3-11.3 9.3-18.3c2.7-17.5-9.5-33.7-27-36.3"/>
                </svg>
              </a>
            {% endif %}
          {% endif %}

          <!-- Кнопка "В избранное" -->
          {% if album in request.user.customer.favorite.all %}
            <a href="{% url 'remove_from_favorite' album_id=album.id %}" class="p-1.5 bg-gray-100 text-red-500 rounded-md hover:bg-gray-200 transition-all duration-300 hover:scale-105" title="Удалить из избранного">
              <svg class="w-5 h-5" xmlns="http://www.w3.org/2000/svg" fill="currentColor" viewBox="0 0 24 24">
                <path d="M21 8.25c0-2.485-2.099-4.5-4.688-4.5-1.935 0-3.597 1.126-4.312 2.733-.715-1.607-2.377-2.733-4.313-2.733C5.1 3.75 3 5.765 3 8.25c0 7.22 9 12 9 12s9-4.78 9-12z" />
              </svg>
            </a>
          {% else %}
            <a href="{% url 'add_to_favorite' album_id=album.id %}" class="p-1.5 bg-gray-100 text-gray-400 rounded-md hover:bg-gray-200 transition-all duration-300 hover:scale-105" title="Добавить в избранное">
              <svg class="w-5 h-5" xmlns="http://www.w3.org/2000/svg" fill="currentColor" viewBox="0 0 24 24">
                <path d="M21 8.25c0-2.485-2.099-4.5-4.688-4.5-1.935 0-3.597 1.126-4.312 2.733-.715-1.607-2.377-2.733-4.313-2.733C5.1 3.75 3 5.765 3 8.25c0 7.22 9 12 9 12s9-4.78 9-12z" />
              </svg>
            </a>
          {% endif %}
        {% else %}
          <!-- Кнопка для неавторизованных -->
          <a href="{% url 'login' %}" class="p-1.5 bg-blue-600 text-white rounded-md hover:bg-blue-700 transition-all duration-300 hover:scale-105" title="Авторизуйтесь для добавления">
            <svg class="ml-0.5" xmlns="http://www.w3.org/2000/svg" width="23" height="23" viewBox="0 0 24 24">
              <path fill="currentColor" d="M6.25 7.5a3.75 3.75 0 1 1 7.5 0a3.75 3.75 0 0 1-7.5 0m-4 9.5A3.75 3.75 0 0 1 6 13.25h.34c.185 0 .369.03.544.086l.866.283a7.251 7.251 0 0 0 2.967.323a.22.22 0 0 1 .223.3a5.983 5.983 0 0 0-.44 2.258c0 1.252.384 2.415 1.04 3.377c.091.134.003.323-.16.328a40.077 40.077 0 0 1-7.84-.5a1.537 1.537 0 0 1-1.29-1.517z"/>
              <path fill="currentColor" fill-rule="evenodd" d="M12 16.5c0 .972.308 1.872.832 2.607A4.48 4.48 0 0 0 16.5 21a4.5 4.5 0 1 0-4.5-4.5m4.5 3a2.985 2.985 0 0 1-1.524-.415l4.109-4.109A3 3 0 0 1 16.5 19.5m-2.585-1.476l4.109-4.109a3 3 0 0 0-4.109 4.109" clip-rule="evenodd"/>
            </svg>
          </a>
        {% endif %}
      </div>
    </div>
  </div>
</div>

<!-- Предварительная загрузка изображений -->
<link rel="preload" href="{{ album.image.url }}" as="image">
{% for image in album.image_gallery.all|slice:":7" %}
  <link rel="preload" href="{{ image.image.url }}" as="image">
{% endfor %}

<!-- JavaScript для карусели -->
<script>
document.querySelectorAll('[data-carousel]').forEach(carousel => {
  // Найти родительскую карточку
  const card = carousel.closest('.card');
  if (!card) {
    console.error('Card container not found for carousel:', carousel);
    return;
  }

  // Получаем изображения из data-images
  let images = [];
  try {
    images = JSON.parse(carousel.dataset.images);
  } catch (e) {
    console.error('Invalid JSON in data-images:', carousel.dataset.images, e);
    images = [carousel.querySelector('[data-carousel-image]').src];
  }

  // Получаем элементы карусели
  const totalImages = parseInt(carousel.dataset.totalImages, 10) || 1;
  const imageElements = carousel.querySelectorAll('[data-carousel-image]');
  const dotsContainer = card.querySelector('[data-carousel-dots]');
  const dotElements = dotsContainer ? dotsContainer.querySelectorAll('[data-dot-index]') : [];

  // Отладка
  console.log('Total images:', totalImages, 'Images:', images.length, 'Image elements:', imageElements.length, 'Dots:', dotElements.length);

  // Проверка загрузки изображений
  imageElements.forEach((img, index) => {
    img.addEventListener('error', () => console.error(`Failed to load image ${index + 1}: ${img.src}`));
    img.addEventListener('load', () => console.log(`Image ${index + 1} loaded: ${img.src}`));
  });

  // Если только одно изображение, отключаем карусель
  if (totalImages <= 1 || imageElements.length <= 1) {
    carousel.style.cursor = 'default';
    if (dotElements[0]) {
      dotElements[0].classList.add('bg-black/80');
      dotElements[0].classList.remove('bg-black/20');
    }
    return;
  }

  let currentIndex = 0;

  // Функция обновления карусели
  function updateCarousel(newIndex) {
    if (newIndex === currentIndex || newIndex < 0 || newIndex >= totalImages || !imageElements[newIndex]) {
      console.warn('Invalid index or no image element:', newIndex);
      return;
    }

    // Сбрасываем z-index текущего изображения
    imageElements[currentIndex].classList.remove('z-10');
    imageElements[currentIndex].classList.add('z-0');

    // Обновляем стиль текущей точки
    if (dotElements[currentIndex]) {
      dotElements[currentIndex].classList.remove('bg-black/80');
      dotElements[currentIndex].classList.add('bg-black/20');
    }

    // Показываем новое изображение
    currentIndex = newIndex;
    imageElements[currentIndex].classList.remove('z-0');
    imageElements[currentIndex].classList.add('z-10');

    // Обновляем стиль новой точки
    if (dotElements[currentIndex]) {
      dotElements[currentIndex].classList.remove('bg-black/20');
      dotElements[currentIndex].classList.add('bg-black/80');
    }

    // Отладка
    console.log(`Switched to image ${newIndex + 1}, Dot classes:`, dotElements[newIndex]?.classList.toString());
  }

  // Обработчик клика по точкам
  dotElements.forEach((dot, index) => {
    dot.addEventListener('click', () => {
      console.log(`Clicked dot ${index + 1}`);
      updateCarousel(index);
    });
    // Поддержка клавиш для доступности
    dot.addEventListener('keydown', (e) => {
      if (e.key === 'Enter' || e.key === ' ') {
        e.preventDefault();
        console.log(`Keydown on dot ${index + 1}`);
        updateCarousel(index);
      }
    });
  });

  // Обработчик наведения курсора
  carousel.addEventListener('mousemove', (e) => {
    const rect = carousel.getBoundingClientRect();
    const relativeX = e.clientX - rect.left;
    const width = rect.width;
    const zoneWidth = width / totalImages;
    const zoneIndex = Math.min(Math.floor(relativeX / zoneWidth), totalImages - 1);
    updateCarousel(zoneIndex);
  });

  // При уходе курсора возвращаем первое изображение
  carousel.addEventListener('mouseleave', () => {
    updateCarousel(0);
  });

  // Инициализация: подсвечиваем первую точку
  if (dotElements[0]) {
    dotElements[0].classList.remove('bg-black/20');
    dotElements[0].classList.add('bg-black/80');
    console.log('Initialized first dot as active');
  }

  // Инициализация: первое изображение на переднем плане
  if (imageElements[0]) {
    imageElements[0].classList.add('z-10');
  }
});
</script>